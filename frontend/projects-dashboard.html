<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ–µ–∫—Ç—ã - Synthnova EDIT</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-br from-gray-900 via-purple-900 to-gray-900 min-h-screen text-white">
    
    <!-- Header -->
    <header class="bg-gray-800/50 backdrop-blur-lg border-b border-purple-500/30 sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <i class="fas fa-video text-purple-400 text-2xl"></i>
                    <h1 class="text-2xl font-bold">Synthnova EDIT</h1>
                </div>
                <div class="flex items-center gap-4">
                    <button onclick="window.location.href='/dashboard'" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition">
                        <i class="fas fa-home mr-2"></i>–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã
                    </button>
                    <button onclick="window.location.href='/combinations.html'" class="px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 rounded-lg transition">
                        <i class="fas fa-random mr-2"></i>–ö–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∏–∫–∞
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Action Panel -->
        <div id="actionPanel" class="bg-gray-800/50 backdrop-blur-lg rounded-2xl border border-purple-500/30 p-4 mb-6 hidden">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <span class="text-sm text-gray-300">
                        <i class="fas fa-check-square mr-2"></i>
                        –í—ã–±—Ä–∞–Ω–æ: <span id="selectedCount" class="font-semibold text-purple-400">0</span>
                    </span>
                    <button onclick="selectAll()" class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm transition">
                        <i class="fas fa-check-double mr-1"></i>–í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                    </button>
                    <button onclick="deselectAll()" class="px-3 py-1 bg-gray-600 hover:bg-gray-700 rounded-lg text-sm transition">
                        <i class="fas fa-times mr-1"></i>–°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                    </button>
                </div>
                <div class="flex gap-2">
                    <button onclick="createMasterVideo()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg transition">
                        <i class="fas fa-film mr-2"></i>–°–æ–∑–¥–∞—Ç—å master-—Ä–æ–ª–∏–∫
                    </button>
                    <button onclick="deleteSelected()" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition">
                        <i class="fas fa-trash mr-2"></i>–£–¥–∞–ª–∏—Ç—å
                    </button>
                </div>
            </div>
        </div>
        
        <div id="projectsContainer" class="space-y-8">
            <!-- Projects will be loaded here -->
        </div>
    </main>

    <!-- Video Modal -->
    <div id="videoModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="relative max-w-5xl w-full bg-gray-900 rounded-2xl overflow-hidden shadow-2xl">
            <button onclick="closeVideoModal()" class="absolute top-4 right-4 z-10 w-10 h-10 bg-red-600 hover:bg-red-700 rounded-full flex items-center justify-center transition">
                <i class="fas fa-times"></i>
            </button>
            
            <video id="modalVideo" class="w-full" controls autoplay>
                <source id="modalVideoSource" src="" type="video/mp4">
            </video>
            
            <div id="modalVideoInfo" class="p-4 bg-gray-800 text-white">
                <h3 id="modalVideoTitle" class="font-semibold text-lg mb-2"></h3>
                <div class="flex gap-4 text-sm text-gray-300">
                    <span><i class="fas fa-tag mr-1"></i><span id="modalVideoType"></span></span>
                    <span><i class="fas fa-hdd mr-1"></i><span id="modalVideoSize"></span></span>
                    <span><i class="fas fa-calendar mr-1"></i><span id="modalVideoDate"></span></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Master Video Modal -->
    <div id="createMasterModal" class="hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="relative max-w-2xl w-full bg-gray-900 rounded-2xl overflow-hidden shadow-2xl">
            <button onclick="closeMasterModal()" class="absolute top-4 right-4 z-10 w-10 h-10 bg-red-600 hover:bg-red-700 rounded-full flex items-center justify-center transition">
                <i class="fas fa-times"></i>
            </button>
            
            <div class="p-6">
                <h2 class="text-2xl font-bold mb-4 flex items-center gap-3">
                    <i class="fas fa-film text-green-400"></i>
                    –°–æ–∑–¥–∞—Ç—å master-—Ä–æ–ª–∏–∫
                </h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ master-—Ä–æ–ª–∏–∫–∞</label>
                    <input type="text" 
                           id="masterVideoName" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ..."
                           class="w-full px-4 py-2 bg-gray-800 border border-purple-500/30 rounded-lg text-white focus:outline-none focus:border-purple-500">
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-semibold mb-2">–í—ã–±—Ä–∞–Ω–æ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤: <span id="modalSelectedCount" class="text-purple-400">0</span></label>
                    <div id="selectedAssetsList" class="max-h-48 overflow-y-auto bg-gray-800 rounded-lg p-3">
                        <!-- –°–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ -->
                    </div>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="submitCreateMasterVideo()" class="flex-1 px-6 py-3 bg-green-600 hover:bg-green-700 rounded-lg font-semibold transition">
                        <i class="fas fa-check mr-2"></i>–°–æ–∑–¥–∞—Ç—å
                    </button>
                    <button onclick="closeMasterModal()" class="px-6 py-3 bg-gray-600 hover:bg-gray-700 rounded-lg font-semibold transition">
                        –û—Ç–º–µ–Ω–∞
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let allProjects = [];
        
        // Load all projects
        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                const data = await response.json();
                allProjects = data.projects || [];
                
                renderProjects();
            } catch (error) {
                console.error('Failed to load projects:', error);
                document.getElementById('projectsContainer').innerHTML = `
                    <div class="text-center text-red-400 p-8">
                        <i class="fas fa-exclamation-triangle text-4xl mb-4"></i>
                        <p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–µ–∫—Ç–æ–≤</p>
                    </div>
                `;
            }
        }
        
        // Render all projects
        function renderProjects() {
            const container = document.getElementById('projectsContainer');
            
            if (allProjects.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-400 p-8">
                        <i class="fas fa-folder-open text-6xl mb-4"></i>
                        <p class="text-xl">–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = allProjects.map(project => `
                <div class="bg-gray-800/50 backdrop-blur-lg rounded-2xl border border-purple-500/30 p-6">
                    <!-- Project Header -->
                    <div class="flex items-center justify-between mb-6 pb-4 border-b border-purple-500/20">
                        <div>
                            <h2 class="text-2xl font-bold flex items-center gap-3">
                                <i class="fas fa-folder text-purple-400"></i>
                                ${project.name}
                            </h2>
                            <p class="text-gray-400 text-sm mt-1">${project.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
                            <div class="flex gap-4 mt-2 text-sm">
                                <span class="text-purple-300">
                                    <i class="fas fa-film mr-1"></i>
                                    ${project.stats?.assets || 0} –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
                                </span>
                                <span class="text-green-300">
                                    <i class="fas fa-check-circle mr-1"></i>
                                    ${project.stats?.master_videos || 0} master-—Ä–æ–ª–∏–∫–æ–≤
                                </span>
                            </div>
                        </div>
                        <button onclick="loadProjectDetails('${project.project_id}')" 
                                class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition">
                            <i class="fas fa-eye mr-2"></i>–û—Ç–∫—Ä—ã—Ç—å
                        </button>
                    </div>
                    
                    <!-- Project Content (–±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –ø—Ä–∏ —Ä–∞—Å–∫—Ä—ã—Ç–∏–∏) -->
                    <div id="project-${project.project_id}" class="hidden">
                        <div class="flex items-center justify-center py-8">
                            <i class="fas fa-spinner fa-spin text-3xl text-purple-400"></i>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Load project details (assets + master videos)
        async function loadProjectDetails(projectId) {
            const container = document.getElementById(`project-${projectId}`);
            
            // Toggle visibility
            if (!container.classList.contains('hidden')) {
                container.classList.add('hidden');
                return;
            }
            
            container.classList.remove('hidden');
            
            try {
                // Load assets and master videos in parallel
                const [assetsRes, masterRes] = await Promise.all([
                    fetch(`/api/projects/${projectId}/assets`),
                    fetch(`/api/projects/${projectId}/master-videos`)
                ]);
                
                const assetsData = await assetsRes.json();
                const masterData = await masterRes.json();
                
                const assets = assetsData.assets || [];
                const masterVideos = masterData.master_videos || [];
                
                // Group assets by type
                const hooks = assets.filter(a => a.asset_type === 'hook');
                const mids = assets.filter(a => a.asset_type === 'mid');
                const ctas = assets.filter(a => a.asset_type === 'cta');
                const targets = assets.filter(a => a.asset_type === 'target_video');
                
                container.innerHTML = `
                    <!-- Materials Section -->
                    <div class="space-y-6">
                        ${renderMaterialsSection('Hooks', hooks, projectId)}
                        ${renderMaterialsSection('Mids', mids, projectId)}
                        ${renderMaterialsSection('CTAs', ctas, projectId)}
                        ${renderMaterialsSection('Target Videos', targets, projectId)}
                        ${renderMasterVideosSection(masterVideos, projectId)}
                    </div>
                `;
            } catch (error) {
                console.error('Failed to load project details:', error);
                container.innerHTML = `
                    <div class="text-center text-red-400 p-4">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
                    </div>
                `;
            }
        }
        
        // Render materials section
        function renderMaterialsSection(title, materials, projectId) {
            if (materials.length === 0) return '';
            
            return `
                <div>
                    <h3 class="text-lg font-semibold mb-3 flex items-center gap-2">
                        <i class="fas fa-layer-group text-purple-400"></i>
                        ${title} <span class="text-sm text-gray-400">(${materials.length})</span>
                    </h3>
                    <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-3">
                        ${materials.map(asset => `
                            <div class="relative group">
                                <!-- –ß–µ–∫–±–æ–∫—Å -->
                                <div class="absolute top-2 left-2 z-10" onclick="event.stopPropagation()">
                                    <input type="checkbox" 
                                           id="asset-${asset.asset_id}" 
                                           class="asset-checkbox w-5 h-5 cursor-pointer"
                                           data-asset-id="${asset.asset_id}"
                                           data-project-id="${projectId}"
                                           onchange="toggleAssetSelection('${asset.asset_id}', '${projectId}')">
                                </div>
                                
                                <div onclick="previewAsset('${asset.asset_id}', '${projectId}')" 
                                     class="relative aspect-[3/4] bg-gradient-to-br from-purple-600 to-blue-600 rounded-lg overflow-hidden cursor-pointer hover:scale-105 transition-transform">
                                    <div class="absolute inset-0 flex items-center justify-center">
                                        <i class="fas fa-play-circle text-white text-4xl group-hover:scale-125 transition-transform"></i>
                                    </div>
                                    <div class="absolute top-2 right-2 bg-black/60 backdrop-blur-sm px-2 py-1 rounded text-xs">
                                        ${asset.asset_type.toUpperCase()}
                                    </div>
                                </div>
                                <p class="text-xs text-gray-300 mt-1 truncate" title="${asset.original_filename}">
                                    ${asset.original_filename}
                                </p>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }
        
        
        // Progress tracking
        let activePolling = new Set();
        
        function startPolling(projectId, masterId) {
            const key = `${projectId}:${masterId}`;
            if (activePolling.has(key)) return;
            
            activePolling.add(key);
            console.log(`üîÑ Started polling for ${masterId}`);
            
            const pollInterval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/projects/${projectId}/master-videos/${masterId}`);
                    const data = await response.json();
                    
                    if (data.success && data.master_video) {
                        const status = data.master_video.status;
                        const updatedAt = new Date(data.master_video.updated_at);
                        
                        const timestampEl = document.getElementById(`timestamp-${masterId}`);
                        if (timestampEl) {
                            timestampEl.textContent = `–æ–±–Ω–æ–≤–ª–µ–Ω–æ ${getTimeAgo(updatedAt)}`;
                        }
                        
                        if (status === 'completed' || status === 'failed') {
                            console.log(`‚úÖ Polling stopped for ${masterId}: ${status}`);
                            clearInterval(pollInterval);
                            activePolling.delete(key);
                            loadProject(projectId);
                            
                            if (status === 'completed') {
                                showNotification('‚úÖ Master-—Ä–æ–ª–∏–∫ –≥–æ—Ç–æ–≤!', 'success');
                            } else {
                                showNotification('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏', 'error');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 5000);
            
            setTimeout(() => {
                clearInterval(pollInterval);
                activePolling.delete(key);
            }, 30 * 60 * 1000);
        }
        
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (seconds < 3600) return `${Math.floor(seconds / 60)} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} —á. –Ω–∞–∑–∞–¥`;
            return `${Math.floor(seconds / 86400)} –¥–Ω. –Ω–∞–∑–∞–¥`;
        }

        // Render master videos section
        function renderMasterVideosSection(masterVideos, projectId) {
            if (masterVideos.length === 0) {
                return `
                    <div class="bg-gray-700/30 rounded-lg p-6 text-center">
                        <i class="fas fa-film text-4xl text-gray-500 mb-3"></i>
                        <p class="text-gray-400">–ù–µ—Ç master-—Ä–æ–ª–∏–∫–æ–≤</p>
                        <button class="mt-4 px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition">
                            <i class="fas fa-plus mr-2"></i>–°–æ–∑–¥–∞—Ç—å master-—Ä–æ–ª–∏–∫
                        </button>
                    </div>
                `;
            }
            
            return `
                <div>
                    <h3 class="text-lg font-semibold mb-3 flex items-center gap-2">
                        <i class="fas fa-video text-green-400"></i>
                        Master-—Ä–æ–ª–∏–∫–∏ <span class="text-sm text-gray-400">(${masterVideos.length})</span>
                    </h3>
                    <div class="space-y-3">
                        ${masterVideos.map(master => {
                            const statusColors = {
                                'created': 'bg-blue-500',
                                'pending': 'bg-yellow-500',
                                'processing': 'bg-orange-500',
                                'completed': 'bg-green-500',
                                'failed': 'bg-red-500'
                            };
                            
                            const statusTexts = {
                                'created': '–°–æ–∑–¥–∞–Ω',
                                'pending': '–í –æ—á–µ—Ä–µ–¥–∏',
                                'processing': '–û–±—Ä–∞–±–æ—Ç–∫–∞',
                                'completed': '–ì–æ—Ç–æ–≤',
                                'failed': '–û—à–∏–±–∫–∞'
                            };
                            
                            const statusColor = statusColors[master.status] || 'bg-gray-500';
                            const statusText = statusTexts[master.status] || master.status;
                            
                            return `
                            <div class="bg-gray-700/50 rounded-lg p-4 flex items-center justify-between hover:bg-gray-700/70 transition">
                                <div class="flex items-center gap-4 flex-1">
                                    <div class="w-32 aspect-video bg-gradient-to-br from-green-600 to-teal-600 rounded flex items-center justify-center relative">
                                        <i class="fas fa-film text-2xl"></i>
                                        ${master.status === 'processing' ? '<div class="absolute inset-0 bg-black/50 flex items-center justify-center"><i class="fas fa-spinner fa-spin text-xl"></i></div>' : ''}
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="font-semibold">${master.name}</h4>
                                        <div class="flex items-center gap-3 mt-1">
                                            <span class="${statusColor} text-white text-xs px-2 py-1 rounded">
                                                ${statusText}
                                            </span>
                                            <span class="text-xs text-gray-400">
                                                ${new Date(master.created_at).toLocaleDateString('ru-RU')}
                                            </span>
                                            <span class="text-xs text-gray-400">
                                                ${master.shots_config.length} –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
                                            </span>
                                            <span class="text-xs text-gray-500" id="timestamp-${master.master_id}">
                                                <i class="fas fa-clock mr-1"></i>–æ–±–Ω–æ–≤–ª–µ–Ω–æ ${getTimeAgo(new Date(master.updated_at))}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    ${master.status === 'completed' ? `
                                        <button onclick="previewMasterVideo('${master.master_id}', '${projectId}')" 
                                                class="px-3 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition">
                                            <i class="fas fa-play mr-2"></i>–ü—Ä–æ—Å–º–æ—Ç—Ä
                                        </button>
                                        <button onclick="downloadMasterVideo('${master.master_id}', '${projectId}')" 
                                                class="px-3 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg transition">
                                            <i class="fas fa-download mr-2"></i>–°–∫–∞—á–∞—Ç—å
                                        </button>
                                        <button onclick="openCombinationsModal('${master.master_id}', '${projectId}')" class="px-3 py-2 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 rounded-lg transition">
                                            <i class="fas fa-random mr-2"></i>–ö–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∏–∫–∞
                                        </button>
                                        <button onclick="openScaleModal('${master.master_id}', '${projectId}')" class="px-3 py-2 bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 rounded-lg transition">
                                            <i class="fas fa-cut mr-2"></i>–ù–∞—Ä–µ–∑–∞—Ç—å
                                        </button>
                                    ` : master.status === 'processing' ? `
                                        <button class="px-3 py-2 bg-gray-600 cursor-not-allowed rounded-lg" disabled>
                                            <i class="fas fa-spinner fa-spin mr-2"></i>–û–±—Ä–∞–±–æ—Ç–∫–∞...
                                        </button>
                                    ` : master.status === 'failed' ? `
                                        <button onclick="retryMasterVideo('${master.master_id}', '${projectId}')" 
                                                class="px-3 py-2 bg-red-600 hover:bg-red-700 rounded-lg transition">
                                            <i class="fas fa-redo mr-2"></i>–ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                                        </button>
                                    ` : `
                                        <button class="px-3 py-2 bg-gray-600 cursor-not-allowed rounded-lg" disabled>
                                            <i class="fas fa-clock mr-2"></i>–û–∂–∏–¥–∞–Ω–∏–µ
                                        </button>
                                    `}
                                    <button onclick="deleteMasterVideo('${master.master_id}', '${projectId}')" 
                                            class="px-3 py-2 bg-red-600/50 hover:bg-red-600 rounded-lg transition">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }
        
        // Preview asset
        function previewAsset(assetId, projectId) {
            fetch(`/api/projects/${projectId}/assets`)
                .then(res => res.json())
                .then(data => {
                    const asset = data.assets.find(a => a.asset_id === assetId);
                    if (!asset) return;
                    
                    const modal = document.getElementById('videoModal');
                    const video = document.getElementById('modalVideo');
                    const source = document.getElementById('modalVideoSource');
                    
                    const videoUrl = asset.cdn_url || `/api/projects/${projectId}/assets/${asset.asset_id}/video`;
                    
                    source.src = videoUrl;
                    video.load();
                    
                    document.getElementById('modalVideoTitle').textContent = asset.original_filename;
                    document.getElementById('modalVideoType').textContent = asset.asset_type.toUpperCase();
                    document.getElementById('modalVideoSize').textContent = `${(asset.file_size / 1024 / 1024).toFixed(2)} MB`;
                    document.getElementById('modalVideoDate').textContent = new Date(asset.created_at).toLocaleDateString('ru-RU');
                    
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    
                    video.onerror = () => {
                        alert(`–í–∏–¥–µ–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ: ${videoUrl}. –í–æ–∑–º–æ–∂–Ω–æ —Ñ–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∏–ª–∏ URL –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –ë–î.`);
                    };
                    
                    video.play().catch(err => console.error('Play error:', err));
                });
        }
        
        // Preview master video
        async function previewMasterVideo(masterId, projectId) {
            try {
                const response = await fetch(`/api/projects/${projectId}/master-videos/${masterId}`);
                const data = await response.json();
                
                if (data.success && data.master_video.video_path) {
                    const modal = document.getElementById('videoModal');
                    const video = document.getElementById('modalVideo');
                    const source = document.getElementById('modalVideoSource');
                    
                    source.src = `/api/projects/${projectId}/master-videos/${masterId}/video`;
                    video.load();
                    
                    document.getElementById('modalVideoTitle').textContent = data.master_video.name;
                    document.getElementById('modalVideoType').textContent = 'MASTER VIDEO';
                    document.getElementById('modalVideoSize').textContent = '';
                    document.getElementById('modalVideoDate').textContent = new Date(data.master_video.created_at).toLocaleDateString('ru-RU');
                    
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                    
                    video.play().catch(err => console.error('Play error:', err));
                } else {
                    showNotification('–í–∏–¥–µ–æ –µ—â—ë –Ω–µ –≥–æ—Ç–æ–≤–æ', 'warning');
                }
            } catch (error) {
                console.error('Failed to load master video:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ', 'error');
            }
        }
        
        function downloadMasterVideo(masterId, projectId) {
            showNotification('–°–∫–∞—á–∏–≤–∞–Ω–∏–µ –Ω–∞—á–∞—Ç–æ...', 'info');
            window.location.href = `/api/projects/${projectId}/master-videos/${masterId}/download`;
        }
        
        function retryMasterVideo(masterId, projectId) {
            showNotification('–ü–æ–≤—Ç–æ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)', 'info');
        }
        
        async function deleteMasterVideo(masterId, projectId) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å master-—Ä–æ–ª–∏–∫?')) return;
            
            try {
                const response = await fetch(`/api/projects/${projectId}/master-videos/${masterId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Master-—Ä–æ–ª–∏–∫ —É–¥–∞–ª—ë–Ω', 'success');
                    loadProjectDetails(projectId);
                } else {
                    showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
                }
            } catch (error) {
                console.error('Failed to delete master video:', error);
                showNotification('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
            }
        }
        
        // Cut master video (scale)
        let currentScaleMaster = null;
        let currentScaleProject = null;
        
        async function cutMasterVideo(masterId, projectId) {
            currentScaleMaster = masterId;
            currentScaleProject = projectId;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ master-–≤–∏–¥–µ–æ
            try {
                const response = await fetch(`/api/projects/${projectId}/master-videos/${masterId}`);
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('scaleMasterName').textContent = data.master_video.name;
                    document.getElementById('scaleCount').value = 10;
                    document.getElementById('scaleCountValue').textContent = '10';
                    
                    const modal = document.getElementById('scaleModal');
                    modal.classList.remove('hidden');
                    modal.classList.add('flex');
                } else {
                    showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ master-—Ä–æ–ª–∏–∫–∞', 'error');
                }
            } catch (error) {
                console.error('Failed to load master video:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ master-—Ä–æ–ª–∏–∫–∞', 'error');
            }
        }
        
        function closeScaleModal() {
            const modal = document.getElementById('scaleModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            currentScaleMaster = null;
            currentScaleProject = null;
        }
        
        async function submitScale() {
            const count = parseInt(document.getElementById('scaleCount').value);
            
            if (count < 1 || count > 100) {
                showNotification('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 100', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/projects/${currentScaleProject}/scale`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        master_video_id: currentScaleMaster,
                        count: count
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeScaleModal();
                    showNotification(`‚úÖ –ó–∞–ø—É—â–µ–Ω–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏—è ${count} —Ä–æ–ª–∏–∫–æ–≤!`, 'success');
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–¥–∞—á–µ
                    setTimeout(() => {
                        showNotification(`Job ID: ${data.job.job_id} - —Å—Ç–∞—Ç—É—Å: ${data.job.status}`, 'info');
                    }, 1000);
                } else {
                    showNotification(`‚ùå –û—à–∏–±–∫–∞: ${data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞—Ä–µ–∑–∫—É'}`, 'error');
                }
            } catch (error) {
                console.error('Failed to start scaling:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –Ω–∞—Ä–µ–∑–∫–∏', 'error');
            }
        }
        
        // Close video modal
        function closeVideoModal() {
            const modal = document.getElementById('videoModal');
            const video = document.getElementById('modalVideo');
            
            video.pause();
            video.currentTime = 0;
            
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }
        
        // Close modals on Escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeVideoModal();
                closeMasterModal();
                closeScaleModal();
            }
        });
        
        // Selection management
        let selectedAssets = new Set();
        
        function toggleAssetSelection(assetId, projectId) {
            const key = `${projectId}:${assetId}`;
            if (selectedAssets.has(key)) {
                selectedAssets.delete(key);
            } else {
                selectedAssets.add(key);
            }
            updateSelectionUI();
        }
        
        function updateSelectionUI() {
            const count = selectedAssets.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('actionPanel').classList.toggle('hidden', count === 0);
        }
        
        function selectAll() {
            document.querySelectorAll('.asset-checkbox').forEach(checkbox => {
                checkbox.checked = true;
                const projectId = checkbox.dataset.projectId;
                const assetId = checkbox.dataset.assetId;
                selectedAssets.add(`${projectId}:${assetId}`);
            });
            updateSelectionUI();
        }
        
        function deselectAll() {
            document.querySelectorAll('.asset-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            selectedAssets.clear();
            updateSelectionUI();
        }
        
        function createMasterVideo() {
            if (selectedAssets.size === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è master-—Ä–æ–ª–∏–∫–∞');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            const modal = document.getElementById('createMasterModal');
            document.getElementById('modalSelectedCount').textContent = selectedAssets.size;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
            loadSelectedAssetsList();
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }
        
        async function loadSelectedAssetsList() {
            const container = document.getElementById('selectedAssetsList');
            container.innerHTML = '<div class="text-center text-gray-400 py-4"><i class="fas fa-spinner fa-spin mr-2"></i>–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            const assetsByProject = {};
            
            // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –ø—Ä–æ–µ–∫—Ç–∞–º
            for (const key of selectedAssets) {
                const [projectId, assetId] = key.split(':');
                if (!assetsByProject[projectId]) {
                    assetsByProject[projectId] = [];
                }
                assetsByProject[projectId].push(assetId);
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤
            const assetsData = [];
            for (const [projectId, assetIds] of Object.entries(assetsByProject)) {
                try {
                    const response = await fetch(`/api/projects/${projectId}/assets`);
                    const data = await response.json();
                    const projectAssets = data.assets.filter(a => assetIds.includes(a.asset_id));
                    assetsData.push(...projectAssets.map(a => ({ ...a, projectId })));
                } catch (error) {
                    console.error('Failed to load assets:', error);
                }
            }
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
            container.innerHTML = assetsData.map((asset, index) => `
                <div class="flex items-center gap-3 p-2 bg-gray-700/50 rounded mb-2">
                    <span class="text-gray-400 text-sm font-semibold">${index + 1}.</span>
                    <div class="flex-1">
                        <p class="text-sm font-semibold">${asset.original_filename}</p>
                        <p class="text-xs text-gray-400">${asset.asset_type.toUpperCase()}</p>
                    </div>
                    <span class="text-xs text-purple-400">${(asset.file_size / 1024 / 1024).toFixed(2)} MB</span>
                </div>
            `).join('');
        }
        
        function closeMasterModal() {
            const modal = document.getElementById('createMasterModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.getElementById('masterVideoName').value = '';
        }
        
        async function submitCreateMasterVideo() {
            const name = document.getElementById('masterVideoName').value.trim();
            
            if (!name) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ master-—Ä–æ–ª–∏–∫–∞');
                return;
            }
            
            const selectedList = Array.from(selectedAssets).map(key => {
                const [projectId, assetId] = key.split(':');
                return { projectId, assetId };
            });
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–µ—Ä–≤—ã–π –ø—Ä–æ–µ–∫—Ç (–≤—Å–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∏–∑ –æ–¥–Ω–æ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞)
            const projectId = selectedList[0].projectId;
            
            // –§–æ—Ä–º–∏—Ä—É–µ–º shots_config
            const shots_config = selectedList.map(item => item.assetId);
            
            try {
                const response = await fetch(`/api/projects/${projectId}/master-videos`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: name,
                        shots_config: shots_config,
                        metadata: {
                            created_from: 'dashboard',
                            selected_count: selectedAssets.size
                        }
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    closeMasterModal();
                    deselectAll();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showNotification(`‚úÖ Master-—Ä–æ–ª–∏–∫ "${name}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!`, 'success');
                    
                    // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ–µ–∫—Ç –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ master-videos
                    // –ü—Ä–æ–µ–∫—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç–∫—Ä—ã—Ç, –Ω–∞—Ö–æ–¥–∏–º –µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
                    const projectContainer = document.getElementById(`project-${projectId}`);
                    if (projectContainer && !projectContainer.classList.contains('hidden')) {
                        loadProjectDetails(projectId);
                    }
                } else {
                    alert(`‚ùå –û—à–∏–±–∫–∞: ${data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å master-—Ä–æ–ª–∏–∫'}`);
                }
            } catch (error) {
                console.error('Failed to create master video:', error);
                alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ master-—Ä–æ–ª–∏–∫–∞');
            }
        }
        
        function deleteSelected() {
            if (selectedAssets.size === 0) {
                alert('–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è');
                return;
            }
            
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${selectedAssets.size} –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤?`)) {
                return;
            }
            
            const selectedList = Array.from(selectedAssets).map(key => {
                const [projectId, assetId] = key.split(':');
                return { projectId, assetId };
            });
            
            console.log('Deleting:', selectedList);
            alert(`–£–¥–∞–ª–µ–Ω–∏–µ ${selectedAssets.size} –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)`);
        }
        
        // Notification system
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const id = `notif-${Date.now()}`;
            
            const colors = {
                success: 'bg-green-600',
                error: 'bg-red-600',
                info: 'bg-blue-600',
                warning: 'bg-yellow-600'
            };
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                info: 'fa-info-circle',
                warning: 'fa-exclamation-triangle'
            };
            
            const notification = document.createElement('div');
            notification.id = id;
            notification.className = `${colors[type]} text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px] animate-slide-in`;
            notification.innerHTML = `
                <i class="fas ${icons[type]} text-xl"></i>
                <span class="flex-1">${message}</span>
                <button onclick="this.parentElement.remove()" class="hover:bg-white/20 rounded p-1">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(notification);
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                const notif = document.getElementById(id);
                if (notif) {
                    notif.style.animation = 'slide-out 0.3s ease-out';
                    setTimeout(() => notif.remove(), 300);
                }
            }, 5000);
        }
        
        // Setup modal event listeners after DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            const videoModal = document.getElementById('videoModal');
            if (videoModal) {
                videoModal.addEventListener('click', (e) => {
                    if (e.target.id === 'videoModal') closeVideoModal();
                });
            }
            
            const createMasterModal = document.getElementById('createMasterModal');
            if (createMasterModal) {
                createMasterModal.addEventListener('click', (e) => {
                    if (e.target.id === 'createMasterModal') closeMasterModal();
                });
            }
            
            const scaleModal = document.getElementById('scaleModal');
            if (scaleModal) {
                scaleModal.addEventListener('click', (e) => {
                    if (e.target.id === 'scaleModal') closeScaleModal();
                });
            }
            
            // Initialize after DOM is ready
            loadProjects();
        });

// ============================================================
// –ö–û–ú–ë–ò–ù–ê–¢–û–†–ò–ö–ê: –§—É–Ω–∫—Ü–∏–∏
// ============================================================

let currentMasterId = null;
let currentProjectIdForCombo = null;

async function openCombinationsModal(masterId, projectId) {
    currentMasterId = masterId;
    currentProjectIdForCombo = projectId;
    
    try {
        // –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
        const response = await fetch(`/api/projects/${projectId}/assets`);
        const data = await response.json();
        
        if (!data.success) {
            alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤');
            return;
        }
        
        const assets = data.assets;
        
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Ç–∏–ø–∞–º
        const hooks = assets.filter(a => a.asset_type === 'hook');
        const mids = assets.filter(a => a.asset_type === 'mid');
        const ctas = assets.filter(a => a.asset_type === 'cta');
        
        // –ó–∞–ø–æ–ª–Ω—è–µ–º —á–µ–∫–±–æ–∫—Å—ã
        const hooksDiv = document.getElementById('comboHooksList');
        const midsDiv = document.getElementById('comboMidsList');
        const ctasDiv = document.getElementById('comboCTAsList');
        
        hooksDiv.innerHTML = hooks.map(h => `
            <label class="flex items-center p-2 hover:bg-gray-50 rounded">
                <input type="checkbox" value="${h.asset_id}" 
                       onchange="updateCombinationsCount()"
                       class="mr-2 combo-hook">
                <span>${h.original_filename || h.asset_id}</span>
            </label>
        `).join('');
        
        midsDiv.innerHTML = mids.map(m => `
            <label class="flex items-center p-2 hover:bg-gray-50 rounded">
                <input type="checkbox" value="${m.asset_id}" 
                       onchange="updateCombinationsCount()"
                       class="mr-2 combo-mid">
                <span>${m.original_filename || m.asset_id}</span>
            </label>
        `).join('');
        
        ctasDiv.innerHTML = ctas.map(c => `
            <label class="flex items-center p-2 hover:bg-gray-50 rounded">
                <input type="checkbox" value="${c.asset_id}" 
                       onchange="updateCombinationsCount()"
                       class="mr-2 combo-cta">
                <span>${c.original_filename || c.asset_id}</span>
            </label>
        `).join('');
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª
        document.getElementById('combinationsModal').classList.remove('hidden');
        updateCombinationsCount();
        
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤');
    }
}

function updateCombinationsCount() {
    const hooksCount = document.querySelectorAll('.combo-hook:checked').length;
    const midsCount = document.querySelectorAll('.combo-mid:checked').length;
    const ctasCount = document.querySelectorAll('.combo-cta:checked').length;
    
    const total = hooksCount * midsCount * ctasCount;
    
    document.getElementById('comboTotalCount').textContent = 
        `${hooksCount} √ó ${midsCount} √ó ${ctasCount} = ${total} –º–∞—Å—Ç–µ—Ä-—Ä–æ–ª–∏–∫–æ–≤`;
}

async function startCombinationsGeneration() {
    const selectedHooks = Array.from(document.querySelectorAll('.combo-hook:checked')).map(cb => cb.value);
    const selectedMids = Array.from(document.querySelectorAll('.combo-mid:checked')).map(cb => cb.value);
    const selectedCtas = Array.from(document.querySelectorAll('.combo-cta:checked')).map(cb => cb.value);
    
    if (selectedHooks.length === 0 || selectedMids.length === 0 || selectedCtas.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –ø–æ –æ–¥–Ω–æ–º—É –º–∞—Ç–µ—Ä–∏–∞–ª—É –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞');
        return;
    }
    
    try {
        const response = await fetch(`/api/projects/${currentProjectIdForCombo}/generate-combinations`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                selected_hooks: selectedHooks,
                selected_mids: selectedMids,
                selected_ctas: selectedCtas
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`‚úÖ –ó–∞–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ! Job ID: ${data.job_id}\n–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ: ${data.total_combinations} –∫–æ–º–±–∏–Ω–∞—Ü–∏–π`);
            document.getElementById('combinationsModal').classList.add('hidden');
            setTimeout(() => location.reload(), 2000);
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è');
    }
}

// ============================================================
// –ù–ê–†–ï–ó–ö–ê (SCALE): –§—É–Ω–∫—Ü–∏–∏
// ============================================================

function openScaleModal(masterId, projectId) {
    currentMasterId = masterId;
    currentProjectId = projectId;
    
    document.getElementById('scaleModal').classList.remove('hidden');
    updateScaleCount();
}

function updateScaleCount() {
    const formats = document.querySelectorAll('.scale-format:checked').length;
    const versions = parseInt(document.getElementById('scaleVersions').value) || 1;
    
    const total = formats * versions;
    
    document.getElementById('scaleTotalCount').textContent = 
        `${versions} –≤–µ—Ä—Å–∏–π √ó ${formats} —Ñ–æ—Ä–º–∞—Ç–æ–≤ = ${total} –≤–∏–¥–µ–æ`;
}

async function startScaleGeneration() {
    const selectedFormats = Array.from(document.querySelectorAll('.scale-format:checked')).map(cb => cb.value);
    const versions = parseInt(document.getElementById('scaleVersions').value) || 1;
    
    if (selectedFormats.length === 0) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —Ñ–æ—Ä–º–∞—Ç');
        return;
    }
    
    if (versions < 1 || versions > 100) {
        alert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–µ—Ä—Å–∏–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 1 –¥–æ 100');
        return;
    }
    
    try {
        const response = await fetch(`/api/projects/${currentProjectId}/master-videos/${currentMasterId}/scale`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                formats: selectedFormats,
                versions: versions
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`‚úÖ –ó–∞–¥–∞–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ! Job ID: ${data.job_id}\n–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ: ${data.total_videos} –≤–∏–¥–µ–æ`);
            document.getElementById('scaleModal').classList.add('hidden');
            setTimeout(() => location.reload(), 2000);
        } else {
            alert('‚ùå –û—à–∏–±–∫–∞: ' + data.error);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–¥–∞–Ω–∏—è');
    }
}

    </script>
<!-- –ö–û–ú–ë–ò–ù–ê–¢–û–†–ò–ö–ê: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<!-- ============================================================ -->
<div id="combinationsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-random mr-2 text-purple-600"></i>
                    –ö–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∏–∫–∞: Hook + Mid + CTA
                </h3>
                <button onclick="document.getElementById('combinationsModal').classList.add('hidden')" 
                        class="text-gray-400 hover:text-gray-600 text-2xl">
                    &times;
                </button>
            </div>
        </div>
        
        <div class="p-6 grid grid-cols-3 gap-6">
            <!-- Hooks -->
            <div class="border rounded-lg p-4">
                <h4 class="font-semibold text-lg mb-3 text-purple-600">
                    <i class="fas fa-bullhorn mr-2"></i>Hooks
                </h4>
                <div id="comboHooksList" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            
            <!-- Mids -->
            <div class="border rounded-lg p-4">
                <h4 class="font-semibold text-lg mb-3 text-blue-600">
                    <i class="fas fa-film mr-2"></i>Mids
                </h4>
                <div id="comboMidsList" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
            
            <!-- CTAs -->
            <div class="border rounded-lg p-4">
                <h4 class="font-semibold text-lg mb-3 text-green-600">
                    <i class="fas fa-hand-point-up mr-2"></i>CTAs
                </h4>
                <div id="comboCTAsList" class="space-y-2 max-h-64 overflow-y-auto">
                    <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
            </div>
        </div>
        
        <!-- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä -->
        <div class="px-6 py-4 bg-gradient-to-r from-purple-50 to-blue-50 border-t border-b">
            <div class="flex items-center justify-center">
                <div class="text-center">
                    <p class="text-sm text-gray-600 mb-2">–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ:</p>
                    <p id="comboTotalCount" class="text-2xl font-bold text-purple-600">
                        0 √ó 0 √ó 0 = 0 –º–∞—Å—Ç–µ—Ä-—Ä–æ–ª–∏–∫–æ–≤
                    </p>
                </div>
            </div>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="p-6 flex justify-end gap-3">
            <button onclick="document.getElementById('combinationsModal').classList.add('hidden')" 
                    class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                –û—Ç–º–µ–Ω–∞
            </button>
            <button onclick="startCombinationsGeneration()" 
                    class="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg hover:from-purple-700 hover:to-blue-700">
                <i class="fas fa-play mr-2"></i>–°–æ–∑–¥–∞—Ç—å –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
            </button>
        </div>
    </div>
</div>

<!-- ============================================================ -->
<!-- –ù–ê–†–ï–ó–ö–ê: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ -->
<!-- ============================================================ -->
<div id="scaleModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4">
        <div class="p-6 border-b border-gray-200">
            <div class="flex justify-between items-center">
                <h3 class="text-2xl font-bold text-gray-800">
                    <i class="fas fa-cut mr-2 text-green-600"></i>
                    –ù–∞—Ä–µ–∑–∫–∞ –≤–∏–¥–µ–æ
                </h3>
                <button onclick="document.getElementById('scaleModal').classList.add('hidden')" 
                        class="text-gray-400 hover:text-gray-600 text-2xl">
                    &times;
                </button>
            </div>
        </div>
        
        <div class="p-6">
            <!-- –§–æ—Ä–º–∞—Ç—ã -->
            <div class="mb-6">
                <h4 class="font-semibold text-lg mb-3">–í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç—ã:</h4>
                <div class="grid grid-cols-2 gap-3">
                    <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" value="16:9" 
                               onchange="updateScaleCount()"
                               class="mr-3 scale-format" checked>
                        <div>
                            <div class="font-medium">16:9</div>
                            <div class="text-sm text-gray-500">–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ</div>
                        </div>
                    </label>
                    
                    <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" value="9:16" 
                               onchange="updateScaleCount()"
                               class="mr-3 scale-format" checked>
                        <div>
                            <div class="font-medium">9:16</div>
                            <div class="text-sm text-gray-500">–í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ</div>
                        </div>
                    </label>
                    
                    <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" value="1:1" 
                               onchange="updateScaleCount()"
                               class="mr-3 scale-format">
                        <div>
                            <div class="font-medium">1:1</div>
                            <div class="text-sm text-gray-500">–ö–≤–∞–¥—Ä–∞—Ç</div>
                        </div>
                    </label>
                    
                    <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                        <input type="checkbox" value="4:5" 
                               onchange="updateScaleCount()"
                               class="mr-3 scale-format">
                        <div>
                            <div class="font-medium">4:5</div>
                            <div class="text-sm text-gray-500">Instagram</div>
                        </div>
                    </label>
                </div>
            </div>
            
            <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–µ—Ä—Å–∏–π -->
            <div class="mb-6">
                <h4 class="font-semibold text-lg mb-3">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–µ—Ä—Å–∏–π:</h4>
                <input type="number" 
                       id="scaleVersions" 
                       value="1" 
                       min="1" 
                       max="100" 
                       onchange="updateScaleCount()"
                       class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-green-500">
                <p class="text-sm text-gray-500 mt-2">–û—Ç 1 –¥–æ 100 –≤–µ—Ä—Å–∏–π</p>
            </div>
            
            <!-- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä -->
            <div class="p-4 bg-gradient-to-r from-green-50 to-blue-50 rounded-lg">
                <div class="text-center">
                    <p class="text-sm text-gray-600 mb-2">–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ:</p>
                    <p id="scaleTotalCount" class="text-2xl font-bold text-green-600">
                        1 –≤–µ—Ä—Å–∏–π √ó 2 —Ñ–æ—Ä–º–∞—Ç–æ–≤ = 2 –≤–∏–¥–µ–æ
                    </p>
                </div>
            </div>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∏ -->
        <div class="p-6 border-t flex justify-end gap-3">
            <button onclick="document.getElementById('scaleModal').classList.add('hidden')" 
                    class="px-6 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                –û—Ç–º–µ–Ω–∞
            </button>
            <button onclick="startScaleGeneration()" 
                    class="px-6 py-2 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-lg hover:from-green-700 hover:to-blue-700">
                <i class="fas fa-cut mr-2"></i>–ù–∞—Ä–µ–∑–∞—Ç—å
            </button>
        </div>
    </div>
</div>

</body>
<!-- ============================================================ -->
<!-- –ö–û–ú–ë–ò–ù–ê–¢–û–†–ò–ö–ê MODAL -->
<!-- ============================================================ -->
<div id="combinationsModal" class="modal-overlay hidden">
    <div class="modal-content max-w-3xl">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">
                <i class="fas fa-random mr-2 text-purple-400"></i>
                –ö–æ–º–±–∏–Ω–∞—Ç–æ—Ä–∏–∫–∞ Hook + Mid + CTA
            </h2>
            <button onclick="closeCombinationsModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>

        <div class="space-y-6">
            <!-- –í—ã–±–æ—Ä –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤ -->
            <div class="bg-gray-700/30 rounded-lg p-4">
                <h3 class="text-lg font-semibold mb-4">–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –¥–ª—è –∫–æ–º–±–∏–Ω–∞—Ü–∏–π</h3>
                
                <!-- Hooks -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">
                        <i class="fas fa-fire text-orange-400 mr-2"></i>
                        Hooks (–≤—ã–±–µ—Ä–∏—Ç–µ 1-10):
                    </label>
                    <div id="hooksSelection" class="grid grid-cols-3 gap-2 max-h-40 overflow-y-auto">
                        <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
                    </div>
                </div>

                <!-- Mids -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">
                        <i class="fas fa-film text-blue-400 mr-2"></i>
                        Mids (–≤—ã–±–µ—Ä–∏—Ç–µ 1-10):
                    </label>
                    <div id="midsSelection" class="grid grid-cols-3 gap-2 max-h-40 overflow-y-auto">
                        <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
                    </div>
                </div>

                <!-- CTAs -->
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">
                        <i class="fas fa-bullhorn text-green-400 mr-2"></i>
                        CTAs (–≤—ã–±–µ—Ä–∏—Ç–µ 1-5):
                    </label>
                    <div id="ctasSelection" class="grid grid-cols-3 gap-2 max-h-40 overflow-y-auto">
                        <!-- –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –∑–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è -->
                    </div>
                </div>
            </div>

            <!-- –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∫–æ–º–±–∏–Ω–∞—Ü–∏–π -->
            <div class="bg-gradient-to-r from-indigo-600/20 to-purple-600/20 rounded-lg p-4 border border-indigo-500/30">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-300 mb-1">–§–æ—Ä–º—É–ª–∞:</div>
                        <div class="text-lg font-mono">
                            <span id="comboHooksCount">0</span> hooks √ó 
                            <span id="comboMidsCount">0</span> mids √ó 
                            <span id="comboCtasCount">0</span> ctas
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-300 mb-1">–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ:</div>
                        <div class="text-3xl font-bold text-purple-400" id="comboTotalCount">0</div>
                        <div class="text-xs text-gray-400">master-—Ä–æ–ª–∏–∫–æ–≤</div>
                    </div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="flex gap-3">
                <button onclick="startCombinationsGeneration()" 
                        id="startCombinationsBtn"
                        class="flex-1 px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 rounded-lg font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-magic mr-2"></i>
                    –°–æ–∑–¥–∞—Ç—å –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏
                </button>
                <button onclick="closeCombinationsModal()" 
                        class="px-6 py-3 bg-gray-600 hover:bg-gray-700 rounded-lg transition">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================================ -->
<!-- –ù–ê–†–ï–ó–ö–ê (SCALE) MODAL -->
<!-- ============================================================ -->
<div id="scaleModal" class="modal-overlay hidden">
    <div class="modal-content max-w-2xl">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-bold">
                <i class="fas fa-cut mr-2 text-green-400"></i>
                –ù–∞—Ä–µ–∑–∫–∞ –≤–∏–¥–µ–æ –Ω–∞ –≤–µ—Ä—Å–∏–∏
            </h2>
            <button onclick="closeScaleModal()" class="text-gray-400 hover:text-white">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>

        <div class="space-y-6">
            <!-- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–µ—Ä—Å–∏–π -->
            <div class="bg-gray-700/30 rounded-lg p-4">
                <label class="block text-sm font-medium mb-2">
                    <i class="fas fa-copy mr-2"></i>
                    –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –≤–µ—Ä—Å–∏–π (1-100):
                </label>
                <input type="number" 
                       id="scaleCount" 
                       min="1" 
                       max="100" 
                       value="10" 
                       class="w-full px-4 py-2 bg-gray-700 rounded-lg border border-gray-600 focus:border-green-500 focus:outline-none"
                       onchange="updateScaleEstimate()">
            </div>

            <!-- –í—ã–±–æ—Ä —Ñ–æ—Ä–º–∞—Ç–æ–≤ -->
            <div class="bg-gray-700/30 rounded-lg p-4">
                <label class="block text-sm font-medium mb-3">
                    <i class="fas fa-desktop mr-2"></i>
                    –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç—ã:
                </label>
                <div class="grid grid-cols-2 gap-3">
                    <label class="flex items-center p-3 bg-gray-700/50 rounded-lg cursor-pointer hover:bg-gray-700 transition">
                        <input type="checkbox" 
                               value="16:9" 
                               class="scale-format-checkbox mr-3" 
                               checked
                               onchange="updateScaleEstimate()">
                        <div>
                            <div class="font-semibold">16:9 (Landscape)</div>
                            <div class="text-xs text-gray-400">YouTube, Desktop</div>
                        </div>
                    </label>
                    <label class="flex items-center p-3 bg-gray-700/50 rounded-lg cursor-pointer hover:bg-gray-700 transition">
                        <input type="checkbox" 
                               value="9:16" 
                               class="scale-format-checkbox mr-3"
                               onchange="updateScaleEstimate()">
                        <div>
                            <div class="font-semibold">9:16 (Vertical)</div>
                            <div class="text-xs text-gray-400">TikTok, Reels, Stories</div>
                        </div>
                    </label>
                    <label class="flex items-center p-3 bg-gray-700/50 rounded-lg cursor-pointer hover:bg-gray-700 transition">
                        <input type="checkbox" 
                               value="1:1" 
                               class="scale-format-checkbox mr-3"
                               onchange="updateScaleEstimate()">
                        <div>
                            <div class="font-semibold">1:1 (Square)</div>
                            <div class="text-xs text-gray-400">Instagram Feed</div>
                        </div>
                    </label>
                    <label class="flex items-center p-3 bg-gray-700/50 rounded-lg cursor-pointer hover:bg-gray-700 transition">
                        <input type="checkbox" 
                               value="4:5" 
                               class="scale-format-checkbox mr-3"
                               onchange="updateScaleEstimate()">
                        <div>
                            <div class="font-semibold">4:5 (Portrait)</div>
                            <div class="text-xs text-gray-400">Instagram Portrait</div>
                        </div>
                    </label>
                </div>
            </div>

            <!-- –û—Ü–µ–Ω–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
            <div class="bg-gradient-to-r from-green-600/20 to-teal-600/20 rounded-lg p-4 border border-green-500/30">
                <div class="flex items-center justify-between">
                    <div>
                        <div class="text-sm text-gray-300 mb-1">–ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–æ:</div>
                        <div class="text-lg font-mono">
                            <span id="scaleVersionsCount">10</span> –≤–µ—Ä—Å–∏–π √ó 
                            <span id="scaleFormatsCount">1</span> —Ñ–æ—Ä–º–∞—Ç–∞
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-3xl font-bold text-green-400" id="scaleTotalCount">10</div>
                        <div class="text-xs text-gray-400">—Ñ–∏–Ω–∞–ª—å–Ω—ã—Ö —Ä–æ–ª–∏–∫–æ–≤</div>
                    </div>
                </div>
            </div>

            <!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
            <div class="flex gap-3">
                <button onclick="startScaleGeneration()" 
                        id="startScaleBtn"
                        class="flex-1 px-6 py-3 bg-gradient-to-r from-green-600 to-teal-600 hover:from-green-700 hover:to-teal-700 rounded-lg font-semibold transition disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-scissors mr-2"></i>
                    –ù–∞—á–∞—Ç—å –Ω–∞—Ä–µ–∑–∫—É
                </button>
                <button onclick="closeScaleModal()" 
                        class="px-6 py-3 bg-gray-600 hover:bg-gray-700 rounded-lg transition">
                    –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>
</div>
</html>
